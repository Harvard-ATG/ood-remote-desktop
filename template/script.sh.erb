#!/usr/bin/env bash

this_script="template/script.sh.erb"

log() {
    echo -e "[$(date -Iseconds)][${this_script}] $1"
}

log "Start script"

# Change working directory to user's home directory
cd "${HOME}"

# set -x

# Activate spack and enter apptainer environment
. /shared/spack/share/spack/setup-env.sh
log "Loaded spack"
which spack
spack env activate apptainer
log "Loaded environment"

# Set which container to use
container_image=/shared/apptainerImages/<%= context.desktop %>.sif

# Bind folders to the container file system so it can access and write to them
SING_BIND_LIST=(
  "-B" "/shared/courseSharedFolders"
  "-B" "/shared/spack"
  "-B" "$WORKING_DIR/etc/rstudio:/etc/rstudio"
)
SING_BINDS="${SING_BIND_LIST[@]}"
log "SING_BINDS=${SING_BINDS}"

log "Launching desktop <%= context.desktop %>"

chmod +x "<%= session.staged_root.join("desktops", "#{context.desktop}.sh") %>"
apptainer exec $SING_BINDS $container_image "<%= session.staged_root.join("desktops", "#{context.desktop}.sh") %>"
log "Desktop <%= context.desktop %> ended."
